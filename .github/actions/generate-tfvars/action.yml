name: 'Generate tfvars'
description: 'Gera arquivo terraform.tfvars com base em vari√°veis din√¢micas e segredos'

inputs:
  AWS_REGION:
    required: true
  PROJECT_NAME:
    required: true
  ENVIRONMENT:
    required: true
  GLOBAL_ENV_VARS_JSON:
    required: true
  ENVIRONMENTS:
    required: true

runs:
  using: "composite"
  steps:
    - name: Gerar arquivo terraform.tfvars
      shell: bash
      run: |
        echo "Gerando terraform.tfvars..."

        # Extrair o nome do bucket do JSON global_env_vars
        S3_BUCKET_NAME=$(echo '${{ inputs.GLOBAL_ENV_VARS_JSON }}' | jq -r '.S3_BUCKET_NAME')

        cat <<EOF > terraform.tfvars
aws_region     = "${{ inputs.AWS_REGION }}"
project_name   = "${{ inputs.PROJECT_NAME }}"
environment    = "${{ inputs.ENVIRONMENT }}"
s3_bucket_name = "${S3_BUCKET_NAME}"

global_env_vars = ${{ inputs.GLOBAL_ENV_VARS_JSON }}
environments    = ${{ inputs.ENVIRONMENTS }}
EOF

        echo "Conte√∫do gerado em terraform.tfvars:"
        cat terraform.tfvars


    # -------------------------------
    # ‚úÖ VALIDA√á√ÉO DE ACESSO AWS
    # -------------------------------
    - name: Verificar acesso ao bucket S3
      shell: bash
      run: aws s3 ls s3://${{ inputs.s3_bucket_name }}
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        AWS_REGION: ${{ inputs.aws_region }}

    - name: Validar credenciais AWS (STS)
      shell: bash
      run: aws sts get-caller-identity
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        AWS_REGION: ${{ inputs.aws_region }}

    # -------------------------------
    # üîç DEBUG
    # -------------------------------
    - name: Debug vari√°veis de entrada
      shell: bash
      run: |
        echo "project_name=${{ inputs.project_name }}"
        echo "environment=${{ inputs.environment }}"
        echo "s3_bucket_name=${{ inputs.s3_bucket_name }}"
        echo "aws_region=${{ inputs.aws_region }}"
        echo "terraform_path=${{ inputs.terraform_path }}"
